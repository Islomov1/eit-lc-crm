generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String           @id @default(uuid())
  name            String
  email           String           @unique
  password        String
  role            Role
  createdAt       DateTime         @default(now())
  groups          Group[]          @relation("TeacherGroups")
  parentInvites   ParentInvite[]   @relation("InvitesCreatedByUser")
  reports         Report[]         @relation("TeacherReports")
  supportSessions SupportSession[] @relation("SupportUser")
}

model TelegramUpdate {
  id          String               @id @default(uuid())
  updateId    Int                  @unique
  payload     Json
  status      TelegramUpdateStatus @default(RECEIVED)
  error       String?
  createdAt   DateTime             @default(now())
  processedAt DateTime?
}

model ParentInvite {
  id          String       @id @default(uuid())
  code        String       @unique
  status      InviteStatus @default(ACTIVE)
  studentId   String
  createdById String?
  parentId    String?
  createdAt   DateTime     @default(now())
  usedAt      DateTime?
  expiresAt   DateTime?
  createdBy   User?        @relation("InvitesCreatedByUser", fields: [createdById], references: [id])
  parent      Parent?      @relation("InvitesUsedByParent", fields: [parentId], references: [id])
  student     Student      @relation(fields: [studentId], references: [id])
}

model AnalyticsEvent {
  id        String   @id @default(uuid())
  name      String
  actorType String?
  actorId   String?
  groupId   String?
  studentId String?
  props     Json?
  createdAt DateTime @default(now())

  @@index([name, createdAt])
  @@index([studentId])
  @@index([groupId])
}

model Group {
  id        String       @id @default(uuid())
  name      String
  schedule  ScheduleType
  startTime String
  endTime   String
  month     Int          @default(1)
  status    GroupStatus  @default(NEW)
  programId String
  teacherId String?
  createdAt DateTime     @default(now())
  program   Program      @relation(fields: [programId], references: [id])
  teacher   User?        @relation("TeacherGroups", fields: [teacherId], references: [id])
  reports   Report[]
  students  Student[]
}

model Student {
  id                 String             @id @default(uuid())
  name               String
  createdAt          DateTime           @default(now())
  groupId            String?
  parents            Parent[]
  ParentInvite       ParentInvite[]
  reports            Report[]
  group              Group?             @relation(fields: [groupId], references: [id])
  supportSessions    SupportSession[]
  telegramDeliveries TelegramDelivery[]
}

model Parent {
  id                 String             @id @default(uuid())
  name               String
  phone              String
  telegramId         BigInt?            @unique
  createdAt          DateTime           @default(now())
  studentId          String
  student            Student            @relation(fields: [studentId], references: [id])
  invites            ParentInvite[]     @relation("InvitesUsedByParent")
  telegramDeliveries TelegramDelivery[]

  @@index([studentId])
}

model Report {
  id         String           @id @default(uuid())
  date       DateTime         @default(now())
  dateKey    String
  attendance AttendanceStatus
  homework   HomeworkStatus
  comment    String?
  studentId  String
  teacherId  String
  groupId    String
  group      Group            @relation(fields: [groupId], references: [id])
  student    Student          @relation(fields: [studentId], references: [id])
  teacher    User             @relation("TeacherReports", fields: [teacherId], references: [id])

  @@unique([studentId, dateKey])
  @@index([groupId, dateKey])
}

model SupportSession {
  id        String   @id @default(uuid())
  startTime DateTime
  endTime   DateTime
  comment   String?
  createdAt DateTime @default(now())
  studentId String
  supportId String
  student   Student  @relation(fields: [studentId], references: [id])
  support   User     @relation("SupportUser", fields: [supportId], references: [id])
}

model Program {
  id     String  @id @default(uuid())
  name   String  @unique
  groups Group[]
}

model TelegramDelivery {
  id                String                 @id @default(uuid())
  studentId         String
  parentId          String
  chatId            BigInt
  messageText       String
  parseMode         String?
  actorType         String?
  actorId           String?
  sourceType        String?
  sourceId          String?
  idempotencyKey    String
  status            TelegramDeliveryStatus @default(PENDING)
  attemptCount      Int                    @default(0)
  lastAttemptAt     DateTime?
  nextRetryAt       DateTime?
  sentAt            DateTime?
  telegramMessageId Int?
  error             String?
  errorPayload      Json?
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  parent            Parent                 @relation(fields: [parentId], references: [id])
  student           Student                @relation(fields: [studentId], references: [id])

  @@unique([parentId, idempotencyKey])
  @@index([status, nextRetryAt])
  @@index([studentId, createdAt])
  @@index([parentId, createdAt])
}

enum Role {
  ADMIN
  TEACHER
  SUPPORT
}

enum AttendanceStatus {
  PRESENT
  ABSENT
}

enum HomeworkStatus {
  DONE
  PARTIAL
  NOT_DONE
}

enum ScheduleType {
  MWF
  TTS
}

enum TelegramUpdateStatus {
  RECEIVED
  PROCESSED
  IGNORED
  ERROR
}

enum InviteStatus {
  ACTIVE
  USED
  REVOKED
  EXPIRED
}

enum GroupStatus {
  NEW
  ACTIVE
  FINISHING
  EXPIRED
}

enum TelegramDeliveryStatus {
  PENDING
  SENT
  FAILED
}
